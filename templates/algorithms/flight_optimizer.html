{% extends 'algorithms/base.html' %}

{% block title %}Flight Optimizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">‚úàÔ∏è Optimizador de Vuelos</h1>
        <p class="text-center text-muted mb-5">
            Encuentra el mejor vuelo bas√°ndote en precio, duraci√≥n, escalas y comodidad
        </p>
        <div class="text-center mb-4">
            <a href="{% url 'algorithms:index' %}" class="btn btn-secondary">‚Üê Volver al Inicio</a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Input Section -->
    <div class="col-md-7">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìù Datos de Vuelos</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>Formato de entrada:</strong> Completa los datos de cada vuelo separados por comas.<br>
                    <strong>Ejemplo:</strong> Vuelo A,850,12,1,7
                </div>

                <div id="flights-container">
                    <div class="flight-row mb-2">
                        <div class="row">
                            <div class="col-3">
                                <input type="text" class="form-control form-control-sm" placeholder="Nombre" value="Vuelo A">
                            </div>
                            <div class="col-2">
                                <input type="number" class="form-control form-control-sm" placeholder="Precio ($)" value="850">
                            </div>
                            <div class="col-2">
                                <input type="number" class="form-control form-control-sm" placeholder="Duraci√≥n (hrs)" value="12">
                            </div>
                            <div class="col-2">
                                <input type="number" class="form-control form-control-sm" placeholder="Escalas" value="1">
                            </div>
                            <div class="col-2">
                                <input type="number" class="form-control form-control-sm" placeholder="Comodidad (1-10)" value="7" min="1" max="10">
                            </div>
                            <div class="col-1">
                                <button class="btn btn-sm btn-danger remove-flight">√ó</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="add-flight-btn" class="btn btn-sm btn-secondary mt-2">+ Agregar Vuelo</button>
                <button id="load-example-btn" class="btn btn-sm btn-info mt-2">üìã Cargar Ejemplo</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">‚öôÔ∏è Configuraci√≥n de Optimizaci√≥n</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label>Algoritmo:</label>
                        <select id="algorithm" class="form-control mb-2">
                            {% for key, algo in algorithms.items %}
                            <option value="{{ key }}">{{ algo.name }}</option>
                            {% endfor %}
                        </select>

                        <label>Iteraciones:</label>
                        <input type="number" id="iterations" class="form-control mb-3" value="50" min="10" max="500">
                    </div>

                    <div class="col-md-6">
                        <label>Pesos de Importancia (total debe ser ~1.0):</label>
                        <div class="form-group">
                            <label class="small">Precio: <span id="w-price-val">0.4</span></label>
                            <input type="range" id="w-price" class="form-control-range" min="0" max="100" value="40">
                        </div>
                        <div class="form-group">
                            <label class="small">Duraci√≥n: <span id="w-duration-val">0.3</span></label>
                            <input type="range" id="w-duration" class="form-control-range" min="0" max="100" value="30">
                        </div>
                        <div class="form-group">
                            <label class="small">Escalas: <span id="w-stopovers-val">0.2</span></label>
                            <input type="range" id="w-stopovers" class="form-control-range" min="0" max="100" value="20">
                        </div>
                        <div class="form-group">
                            <label class="small">Comodidad: <span id="w-comfort-val">0.1</span></label>
                            <input type="range" id="w-comfort" class="form-control-range" min="0" max="100" value="10">
                        </div>
                    </div>
                </div>

                <button id="optimize-btn" class="btn btn-primary btn-block w-100 mt-3">
                    üöÄ Optimizar Vuelos
                </button>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">üìä Resultados</h5>
            </div>
            <div class="card-body" id="results-area">
                <p class="text-muted text-center">Configura los vuelos y haz clic en "Optimizar Vuelos"</p>
            </div>
        </div>
    </div>
</div>

<div id="loading-spinner" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3);">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-3"><strong>Optimizando vuelos...</strong></p>
    </div>
</div>

<script>
// Update weight labels in real-time
document.querySelectorAll('input[type="range"]').forEach(slider => {
    slider.addEventListener('input', function() {
        const value = (this.value / 100).toFixed(2);
        document.getElementById(this.id + '-val').textContent = value;
    });
});

// Add flight row
document.getElementById('add-flight-btn').addEventListener('click', function() {
    const container = document.getElementById('flights-container');
    const row = document.createElement('div');
    row.className = 'flight-row mb-2';
    row.innerHTML = `
        <div class="row">
            <div class="col-3">
                <input type="text" class="form-control form-control-sm" placeholder="Nombre">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm" placeholder="Precio ($)">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm" placeholder="Duraci√≥n (hrs)">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm" placeholder="Escalas">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm" placeholder="Comodidad (1-10)" min="1" max="10">
            </div>
            <div class="col-1">
                <button class="btn btn-sm btn-danger remove-flight">√ó</button>
            </div>
        </div>
    `;
    container.appendChild(row);
});

// Remove flight row
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-flight')) {
        const rows = document.querySelectorAll('.flight-row');
        if (rows.length > 1) {
            e.target.closest('.flight-row').remove();
        } else {
            alert('Debe haber al menos un vuelo');
        }
    }
});

// Load example data
document.getElementById('load-example-btn').addEventListener('click', function() {
    const container = document.getElementById('flights-container');
    container.innerHTML = `
        <div class="flight-row mb-2">
            <div class="row">
                <div class="col-3"><input type="text" class="form-control form-control-sm" value="Vuelo A"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="850"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="12"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="1"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="7"></div>
                <div class="col-1"><button class="btn btn-sm btn-danger remove-flight">√ó</button></div>
            </div>
        </div>
        <div class="flight-row mb-2">
            <div class="row">
                <div class="col-3"><input type="text" class="form-control form-control-sm" value="Vuelo B"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="1200"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="9"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="0"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="9"></div>
                <div class="col-1"><button class="btn btn-sm btn-danger remove-flight">√ó</button></div>
            </div>
        </div>
        <div class="flight-row mb-2">
            <div class="row">
                <div class="col-3"><input type="text" class="form-control form-control-sm" value="Vuelo C"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="650"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="20"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="2"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="5"></div>
                <div class="col-1"><button class="btn btn-sm btn-danger remove-flight">√ó</button></div>
            </div>
        </div>
        <div class="flight-row mb-2">
            <div class="row">
                <div class="col-3"><input type="text" class="form-control form-control-sm" value="Vuelo D"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="900"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="14"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="1"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="8"></div>
                <div class="col-1"><button class="btn btn-sm btn-danger remove-flight">√ó</button></div>
            </div>
        </div>
        <div class="flight-row mb-2">
            <div class="row">
                <div class="col-3"><input type="text" class="form-control form-control-sm" value="Vuelo E"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="300"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="18"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="2"></div>
                <div class="col-2"><input type="number" class="form-control form-control-sm" value="10"></div>
                <div class="col-1"><button class="btn btn-sm btn-danger remove-flight">√ó</button></div>
            </div>
        </div>
    `;
});

// Optimize flights
document.getElementById('optimize-btn').addEventListener('click', function() {
    // Collect flight data
    const flightRows = document.querySelectorAll('.flight-row');
    const flights = [];

    flightRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        flights.push({
            name: inputs[0].value,
            price: parseFloat(inputs[1].value),
            duration: parseFloat(inputs[2].value),
            stopovers: parseInt(inputs[3].value),
            comfort: parseFloat(inputs[4].value)
        });
    });

    if (flights.length === 0) {
        alert('Por favor ingrese al menos un vuelo');
        return;
    }

    // Get weights
    const weights = {
        w_price: parseFloat(document.getElementById('w-price').value) / 100,
        w_duration: parseFloat(document.getElementById('w-duration').value) / 100,
        w_stopovers: parseFloat(document.getElementById('w-stopovers').value) / 100,
        w_comfort: parseFloat(document.getElementById('w-comfort').value) / 100
    };

    // Get algorithm
    const algorithm = document.getElementById('algorithm').value;
    const iterations = parseInt(document.getElementById('iterations').value);

    // Show loading
    document.getElementById('loading-spinner').style.display = 'block';

    // Call API
    fetch('{% url "algorithms:optimize_flights" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            flights: flights,
            ...weights,
            algorithm: algorithm,
            iterations: iterations
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading-spinner').style.display = 'none';

        if (data.success) {
            // Display results
            let html = `
                <div class="alert alert-success">
                    <h5>‚úÖ Mejor Vuelo Encontrado</h5>
                    <h4>${data.best_flight.name}</h4>
                    <ul class="list-unstyled mt-3">
                        <li><strong>üí∞ Precio:</strong> $${data.best_flight.price}</li>
                        <li><strong>‚è±Ô∏è Duraci√≥n:</strong> ${data.best_flight.duration} hrs</li>
                        <li><strong>üîÑ Escalas:</strong> ${data.best_flight.stopovers}</li>
                        <li><strong>üòä Comodidad:</strong> ${data.best_flight.comfort}/10</li>
                    </ul>
                    <small class="text-muted">Tiempo de ejecuci√≥n: ${data.execution_time.toFixed(3)}s</small>
                </div>

                <h6 class="mt-4">Ranking de Todos los Vuelos:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Vuelo</th>
                                <th>Precio</th>
                                <th>Duraci√≥n</th>
                                <th>Escalas</th>
                                <th>Comodidad</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.ranking.forEach((flight, idx) => {
                const rowClass = idx === 0 ? 'table-success' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${idx + 1}</td>
                        <td><strong>${flight.name}</strong></td>
                        <td>$${flight.price}</td>
                        <td>${flight.duration}h</td>
                        <td>${flight.stopovers}</td>
                        <td>${flight.comfort}/10</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('results-area').innerHTML = html;
        } else {
            document.getElementById('results-area').innerHTML =
                `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('results-area').innerHTML =
            `<div class="alert alert-danger">Error: ${error}</div>`;
    });
});
</script>

{% endblock %}
